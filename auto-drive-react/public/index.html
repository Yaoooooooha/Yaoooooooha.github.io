<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <!-- <link rel="icon" href="%PUBLIC_URL%/填入圖片網址" /> -->
    <meta
      name="viewport"
      content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0, initial-scale=1"
    />
    <meta name="theme-color" content="#000000" />
    <meta name="google" content="notranslate" />
    <!-- <meta
      name="description"
      content="填入網站描述"
    /> -->
    <!-- 用於指定社交媒體平台（如 Facebook、Twitter 等）在分享網頁時顯示的內容，包括標題、描述、圖片等 -->
    <!-- <meta
    property="og:image"
    content="填入圖片網址"
  /> -->

    <!-- 設置網頁的 Apple 觸控圖標。當用戶將網站添加到主屏幕時，或者在 iOS 的 Safari 瀏覽器中將其作為書籤添加時，將使用此圖標作為應用程式的圖標 -->
    <!-- <link rel="apple-touch-icon" href="%PUBLIC_URL%/填入圖片網址"/> -->

    <!--
      manifest.json provides metadata used when your web app is installed on a
      user's mobile device or desktop. See https://developers.google.com/web/fundamentals/web-app-manifest/
    -->
    <link rel="manifest" href="%PUBLIC_URL%/manifest.json" />
    <!-- Google tag (gtag.js) -->
    <!-- <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-0871XE8KKG"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());

      gtag("config", "G-0871XE8KKG");
    </script> -->
    <title>AR Guided Tour</title>
    <!-- <link rel="stylesheet" href="./style.css" /> -->
    <title>AR Self-Driving Car Guided Tour</title>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <!-- 動畫模組 -->
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.2.0/dist/aframe-extras.min.js"></script>
    <!-- for image base (need to comment out "aframe-ar.js")
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script> -->
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>

    <!-- fontawesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
      integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
  </head>
  <body>
    <noscript>You need to enable JavaScript to run this app.</noscript>
    <div id="root"></div>
    <!--
      This HTML file is a template.
      If you open it directly in the browser, you will see an empty page.

      You can add webfonts, meta tags, or analytics to this file.
      The build step will place the bundled scripts into the <body> tag.

      To begin the development, run `npm start` or `yarn start`.
      To create a production bundle, use `npm run build` or `yarn build`.
    -->
    <!-- <script>
      // 調整 canvas 大小

      function resizeCanvas(origCanvas, width, height) {
        let resizedCanvas = document.createElement("canvas");
        let resizedContext = resizedCanvas.getContext("2d");

        resizedCanvas.height = height;
        resizedCanvas.width = width;

        if (width > height) {
          // Landscape
          resizedContext.drawImage(origCanvas, 0, 0, width, height);
        } else {
          // Portrait
          resizedContext.drawImage(origCanvas, 0, 0, height, width);
        }

        return resizedCanvas.toDataURL();
      }

      // 抓取 ar 鏡頭的畫面
      function captureVideoFrame(video, format, width, height) {
        if (typeof video === "string") {
          video = document.querySelector(video);
          console.log(video);
        }

        format = format || "jpeg";

        if (!video || (format !== "png" && format !== "jpeg")) {
          return false;
        }

        var canvas = document.createElement("CANVAS");

        canvas.width = width || video.videoWidth;
        canvas.height = height || video.videoHeight;
        canvas.getContext("2d").drawImage(video, 0, 0);
        var dataUri = canvas.toDataURL("image/" + format);
        var data = dataUri.split(",")[1];
        var mimeType = dataUri.split(";")[0].slice(5);

        var bytes = window.atob(data);
        var buf = new ArrayBuffer(bytes.length);
        var arr = new Uint8Array(buf);

        for (var i = 0; i < bytes.length; i++) {
          arr[i] = bytes.charCodeAt(i);
        }

        var blob = new Blob([arr], { type: mimeType });
        return {
          blob: blob,
          dataUri: dataUri,
          format: format,
          width: canvas.width,
          height: canvas.height,
        };
      }

      // from https://github.com/lukechilds/merge-images
      var defaultOptions = {
        format: "image/png",
        quality: 0.92,
        width: undefined,
        height: undefined,
        Canvas: undefined,
        crossOrigin: undefined,
      };

      // from https://github.com/lukechilds/merge-images
      // 合併 3d 模型和 ar 鏡頭的畫面
      var mergeImages = function (sources, options) {
        if (sources === void 0) sources = [];
        if (options === void 0) options = {};

        return new Promise(function (resolve) {
          options = Object.assign({}, defaultOptions, options);

          // Setup browser/Node.js specific variables
          var canvas = options.Canvas
            ? new options.Canvas()
            : window.document.createElement("canvas");
          var Image = options.Image || window.Image;

          // Load sources
          var images = sources.map(function (source) {
            return new Promise(function (resolve, reject) {
              // Convert sources to objects
              if (source.constructor.name !== "Object") {
                source = { src: source };
              }

              // Resolve source and img when loaded
              var img = new Image();
              img.crossOrigin = options.crossOrigin;
              img.onerror = function () {
                return reject(new Error("Couldn't load image"));
              };
              img.onload = function () {
                return resolve(Object.assign({}, source, { img: img }));
              };
              img.src = source.src;
            });
          });

          // Get canvas context
          var ctx = canvas.getContext("2d");

          // When sources have loaded
          resolve(
            Promise.all(images).then(function (images) {
              // Set canvas dimensions
              var getSize = function (dim) {
                return (
                  options[dim] ||
                  Math.max.apply(
                    Math,
                    images.map(function (image) {
                      return image.img[dim];
                    })
                  )
                );
              };
              canvas.width = getSize("width");
              canvas.height = getSize("height");

              // Draw images to canvas
              images.forEach(function (image) {
                ctx.globalAlpha = image.opacity ? image.opacity : 1;
                return ctx.drawImage(image.img, image.x || 0, image.y || 0);
              });

              if (options.Canvas && options.format === "image/jpeg") {
                // Resolve data URI for node-canvas jpeg async
                return new Promise(function (resolve, reject) {
                  canvas.toDataURL(
                    options.format,
                    {
                      quality: options.quality,
                      progressive: false,
                    },
                    function (err, jpeg) {
                      if (err) {
                        reject(err);
                        return;
                      }
                      resolve(jpeg);
                    }
                  );
                });
              }

              // Resolve all other data URIs sync
              return canvas.toDataURL(options.format, options.quality);
            })
          );
        });
      };

      // 點按拍攝鍵後拍照
      let screenshotBtn = document.getElementById("take-picture");
      screenshotBtn.addEventListener("click", function () {
        // 使用 a-frame 內建的截圖功能(只截的到 3D 模型)
        let aScene = document
          .querySelector("a-scene")
          .components.screenshot.getCanvas("perspective");
        // 抓取 ar 視訊鏡頭的畫面，然後繪製到 canva 上變成圖片
        let frame = captureVideoFrame("#arjs-video", "png");
        aScene = resizeCanvas(aScene, frame.width, frame.height);
        frame = frame.dataUri;
        mergeImages([frame, aScene]).then((b64) => {
          // 建造一個臨時下載點
          let link = document.createElement("a");
          link.setAttribute("download", "AR.png");
          link.setAttribute("href", b64);
          // 將臨時元素添加到文檔中
          document.body.appendChild(link);
          // 模擬典籍下載連結
          link.click();
          // 移除臨時元素
          document.body.removeChild(link);
        });
      });
    </script> -->
  </body>
</html>
